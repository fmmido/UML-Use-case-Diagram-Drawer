<!DOCTYPE html>
<html>
<head>
  <title>UML Use Case Diagram</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/4.5.0/fabric.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.1/sql-wasm.js"></script>
  <style>
    .control-panel {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="control-panel">
    <label for="systemBoundary">Add System Boundary:</label>
    <button onclick="drawSystemBoundary()">Draw Boundary</button>
    
    <label for="actors">Add Actor:</label>
    <select id="actors">
      <option value="Customer">Customer</option>
      <option value="Payment Processor">Payment Processor</option>
    </select>
    <button onclick="addActor()">Add Actor</button>

    <label for="useCases">Add Use Case:</label>
    <select id="useCases">
      <option value="Browse Products">Browse Products</option>
      <option value="Add to Cart">Add to Cart</option>
      <option value="Checkout">Checkout</option>
      <option value="Make Payment">Make Payment</option>
    </select>
    <button onclick="addUseCase()">Add Use Case</button>
    
    <label for="newUseCase">New Use Case:</label>
    <input type="text" id="newUseCase" placeholder="Enter new use case name">
    <button onclick="addNewUseCase()">Add New Use Case</button>

    <label for="relationships">Add Relationship:</label>
    <select id="relationships">
      <option value="Association">Association</option>
      <option value="Include">Include</option>
      <option value="Extend">Extend</option>
      <option value="Generalization">Generalization</option>
    </select>
    <button onclick="addRelationship()">Add Relationship</button>
    
    <label for="diagramName">Diagram Name:</label>
    <input type="text" id="diagramName" placeholder="Enter diagram name">
    <button onclick="saveDiagram()">Save Diagram</button>
    
    <label for="savedDiagrams">Load Diagram:</label>
    <select id="savedDiagrams"></select>
    <button onclick="loadDiagram()">Load Diagram</button>
  </div>

  <canvas id="umlCanvas" width="800" height="600" style="border:1px solid #000;"></canvas>

  <script>
    let db;
    const canvas = new fabric.Canvas('umlCanvas');
    let actorCount = 0;
    let useCaseCount = 0;
    let boundaryDrawn = false;
    let relationshipCount = 0;

    // Initialize the database when the page loads
    window.onload = async function() {
      await initDatabase();
      loadDiagramNames();
    };

    // Store references to actors and use cases
    const actors = [];
    const useCases = [];

    // Function to initialize the database
    async function initDatabase() {
      const SQL = await initSqlJs({ locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.1/sql-wasm.wasm` });
      db = new SQL.Database();

      // Load database from local storage if available
      const storedDb = localStorage.getItem('umlDiagramsDb');
      if (storedDb) {
        db = new SQL.Database(Uint8Array.from(atob(storedDb), c => c.charCodeAt(0)));
      } else {
        db.run("CREATE TABLE IF NOT EXISTS diagrams (id INTEGER PRIMARY KEY, name TEXT, json TEXT)");
      }
    }

    // Function to draw system boundary
    function drawSystemBoundary() {
      if (!boundaryDrawn) {
        const systemBoundary = new fabric.Rect({
          left: 150,
          top: 50,
          width: 500,
          height: 400,
          fill: 'transparent',
          stroke: 'black',
          strokeWidth: 2
        });
        canvas.add(systemBoundary);
        boundaryDrawn = true;
      }
    }

    // Function to add actor
    function addActor() {
      const actorSelect = document.getElementById('actors');
      const actorName = actorSelect.value;
      const actorText = new fabric.Text(actorName, {
        left: 50,
        top: 50 + (actorCount * 50),
        fontSize: 18,
      });
      actors.push(actorText);
      canvas.add(actorText);
      actorCount++;
    }

    // Function to add use case
    function addUseCase() {
      const useCaseSelect = document.getElementById('useCases');
      const useCaseName = useCaseSelect.value;
      const useCaseEllipse = new fabric.Ellipse({
        left: 250,
        top: 100 + (useCaseCount * 100),
        rx: 80,
        ry: 40,
        fill: 'lightgrey',
        stroke: 'black',
        strokeWidth: 1,
      });
      const useCaseText = new fabric.Text(useCaseName, {
        left: 250,
        top: 100 + (useCaseCount * 100),
        fontSize: 16,
        originX: 'center',
        originY: 'center'
      });
      useCases.push({ellipse: useCaseEllipse, text: useCaseText});
      canvas.add(useCaseEllipse, useCaseText);
      useCaseCount++;
    }

    // Function to add new use case name to the dropdown
    function addNewUseCase() {
      const newUseCaseInput = document.getElementById('newUseCase');
      const newUseCaseName = newUseCaseInput.value;
      if (newUseCaseName.trim() !== "") {
        const useCaseSelect = document.getElementById('useCases');
        const newOption = document.createElement('option');
        newOption.value = newUseCaseName;
        newOption.text = newUseCaseName;
        useCaseSelect.appendChild(newOption);
        newUseCaseInput.value = ""; // Clear the input field
      }
    }

    // Function to add relationship
    function addRelationship() {
      const relationshipSelect = document.getElementById('relationships');
      const relationshipType = relationshipSelect.value;

      if (actors.length > 0 && useCases.length > 0) {
        const actor = actors[relationshipCount % actors.length]; // Cycle through actors
        const useCase = useCases[relationshipCount % useCases.length].ellipse; // Cycle through use cases
        
        const offset = relationshipCount * 10; // Offset each new line by 10 pixels
        
        const line = new fabric.Line([actor.left + actor.width, actor.top + offset, useCase.left, useCase.top + offset], {
          stroke: 'black'
        });

        if (relationshipType === "Include" || relationshipType === "Extend") {
          line.set('strokeDashArray', [5, 5]);
        }

        if (relationshipType === "Generalization") {
          line.set('stroke', 'black');
          line.set('strokeWidth', 2);
          const arrow = new fabric.Triangle({
            left: useCase.left,
            top: useCase.top,
            width: 10,
            height: 10,
            fill: 'black',
            angle: 90
          });
          canvas.add(arrow);
        }

        canvas.add(line);
        relationshipCount++;
      }
    }

    // Function to save the current diagram
    function saveDiagram() {
      const diagramName = document.getElementById('diagramName').value;
      if (diagramName.trim() !== "") {
        const json = JSON.stringify(canvas.toJSON());
        const stmt = db.prepare("INSERT INTO diagrams (name, json) VALUES (?, ?)");
        stmt.run([diagramName, json]);
        stmt.free();

        // Save the database to local storage
        const data = db.export();
        const base64Data = btoa(String.fromCharCode.apply(null, data));
        localStorage.setItem('umlDiagramsDb', base64Data);

        loadDiagramNames();
      }
    }

    // Function to load saved diagram names into the dropdown
    function loadDiagramNames() {
      const savedDiagramsSelect = document.getElementById('savedDiagrams');
      savedDiagramsSelect.innerHTML = ''; // Clear the dropdown
      const result = db.exec("SELECT id, name FROM diagrams");
      if (result.length > 0) {
        const rows = result[0].values;
        rows.forEach(row => {
          const option = document.createElement('option');
          option.value = row[0];
          option.text = row[1];
          savedDiagramsSelect.appendChild(option);
        });
      }
    }

    // Function to load a selected diagram
    function loadDiagram() {
      const savedDiagramsSelect = document.getElementById('savedDiagrams');
      const diagramId = savedDiagramsSelect.value;
      if (diagramId) {
        const stmt = db.prepare("SELECT json FROM diagrams WHERE id = ?");
        stmt.bind([diagramId]);
        while (stmt.step()) {
          const row = stmt.getAsObject();
          canvas.loadFromJSON(row.json, () => {
            canvas.renderAll();
          });
        }
        stmt.free();
      }
    }
  </script>
</body>
</html>
